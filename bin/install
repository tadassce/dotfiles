#!/bin/bash

# Install script for a fresh macOS install.
# Before:
# - Install 1P and XCode from the MAS
# - Wait for iCloud Drive to sync

# Verify XCode installed
if ! command -v xcodebuild &> /dev/null; then
  echo "Please install XCode from the App Store"
  exit 1
fi

# Set up dotfiles
if [ ! -d ~/.dotfiles ]; then
  git clone https://github.com/tadassce/dotfiles.git ~/.dotfiles
fi

# Install Homebrew
if command -v brew &> /dev/null; then
  brew update
else
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  brew analytics off
fi

brew bundle check --file ~/.dotfiles/Brewfile || brew bundle --file ~/.dotfiles/Brewfile

asdf plugin-add ruby
latest_ruby=$(asdf list-all ruby | grep "^\d" | grep -v "dev\|rc\|preview" | tail -n1)
asdf install ruby "$latest_ruby"
asdf global ruby "$latest_ruby"

# symlink dotfiles
rcup

[ ! -L ~/.icloud ] && ln -s ~/Library/Mobile\ Documents/com\~apple\~CloudDocs ~/.icloud
[ ! -L ~/.config ] && ln -s ~/.icloud/Config ~/.config
[ ! -L ~/.hammerspoon ] && ln -s ~/.icloud/Config/hammerspoon ~/.hammerspoon
touch ~/.private_aliases
touch ~/.private_profile

# Set the default shell (and in Users' prefs)
# TODO: check if $SHELL ends with /zsh
# chsh -s $(brew --prefix)/bin/zsh

# Vim undo (gitignored)
mkdir -p ~/.vim/undo

# Tmux Plugin Manager
if [ ! -d ~/.tmux/plugins/tpm ]; then
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

# Set some macOS defaults
~/.dotfiles/macos-defaults

# Linters
gem install \
  standard \
  reek \
  rubocop \
  ruby-lint \
  coderay \
  brakeman \
  rails_best_practices
npm i -g \
  standard \
  jshint \
  jsonlint \
  prettier \
  swaglint

echo Done.
