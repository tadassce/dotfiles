#! /usr/bin/env ruby

def emoji
  case `git remote -v`
  when /github/ then '🐙'
  when /gitlab/ then '😸'
  else               '🤖'
  end
end

home = Dir.pwd

Dir['*']
  .select { |d| File.exist?("#{d}/.git") }
  .each do |dir|

  Dir.chdir dir

  name = dir.split('/').last
  print "#{emoji} Updating #{name}... ".ljust(50)

  fetch_output =
    `git fetch --all 2>&1`.
    split("\n").
    select { |x| !x.nil? }.
    select { |x| x !~ /Your access is logged/ }.
    select { |x| x !~ /\AFetching / }


  if !fetch_output.empty?
    puts '✴️'
    puts fetch_output
  end

  current_branch = `git symbolic-ref HEAD | sed 's#^refs/heads/##'`.strip
  if %w{ master dev }.include? current_branch
    rebase_output =
      `git rebase origin/#{current_branch} 2>&1`.
      split("\n").
      select { |x| x !~ /Current branch .* is up to date./ }.
      select { |x| x !~ /Applied autostash/ }

    if !rebase_output.empty?
      puts '✴️'
      puts rebase_output
    else
      puts '✅'
    end
  else
    puts '✅'
  end

  Dir.chdir home
end
